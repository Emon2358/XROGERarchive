# .github/workflows/convert-ram-to-mp3.yml
name: Convert RAM to MP3

on:
  push:
    paths:
      - '**/*.ram'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをフルクローン
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ffmpeg のインストール
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # .ram → .mp3 変換（カバーアートをビデオストリームとしてコピー）
      - name: Convert .ram to .mp3
        run: |
          mkdir -p converted
          find . -type f -name '*.ram' | while read f; do
            out="converted/$(basename "${f%.*}.mp3")"
            ffmpeg -y -i "$f" \
              -codec:a libmp3lame -q:a 2 \
              -codec:v copy \
              -map 0 \
              -id3v2_version 3 \
              "$out"
          done

      # 生成された MP3 をコミット＆プッシュ
      - name: Auto commit & push converted MP3
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "🔄 Convert RAM to MP3"
          file_pattern: converted/**/*.mp3
          push: true
