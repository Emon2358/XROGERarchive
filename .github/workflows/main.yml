name: Convert .ram to MP3

on:
  workflow_dispatch:
    inputs:
      ram_file:
        description: '変換したい .ram ファイル名（例: xrsample1.ram）'
        required: true

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. ffmpeg をインストール
      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libavcodec-extra

      # 3. RAMファイルからRAファイルURLを読み取り、MP3に変換
      - name: Convert RAM to MP3
        run: |
          RAM_FILE="${{ github.event.inputs.ram_file }}"

          if [ ! -f "$RAM_FILE" ]; then
            echo "::error:: $RAM_FILE が見つかりません"
            exit 1
          fi

          echo "::notice:: .ram ファイル内容:"
          cat "$RAM_FILE"

          # .ram ファイルから RA ストリームURLを抽出
          STREAM_URL=$(grep -Eo 'https?://[^ ]+\.ra' "$RAM_FILE" || true)

          if [ -z "$STREAM_URL" ]; then
            echo "::error:: .ram 内に .ra URL が見つかりません"
            exit 1
          fi

          echo "::notice:: RA ストリーム URL: $STREAM_URL"

          # ファイル名をベースに MP3 変換
          BASENAME="${RAM_FILE%.*}"
          OUT_MP3="${BASENAME}.mp3"

          ffmpeg -y -i "$STREAM_URL" -vn -c:a libmp3lame -b:a 192k "$OUT_MP3"

          if [ ! -f "$OUT_MP3" ]; then
            echo "::error:: MP3 の生成に失敗しました"
            exit 1
          fi

      # 4. 生成されたMP3をコミット＆プッシュ
      - name: Commit and push MP3 to repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "*.mp3"
          git commit -m "Add converted MP3 from ${{ github.event.inputs.ram_file }}"
          git push
