name: Convert .ram to MP3 with Cover

on:
  workflow_dispatch:
    inputs:
      ram_file:
        description: '.ram ファイル名（例: xrsample1.ram）'
        required: true

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. ffmpeg と必要なツールをインストール
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libavcodec-extra

      # 3. .ram → MP3 変換（.ram = RealAudio メタファイル）
      - name: Convert .ram to MP3 with cover
        run: |
          RAM_FILE="${{ github.event.inputs.ram_file }}"

          # .ramは実体ファイル（.rm など）へのURLを含むテキストなので読み取る
          STREAM_URL=$(cat "$RAM_FILE" | grep -Eo 'http[s]?://[^ ]+\.ra' || true)

          if [ -z "$STREAM_URL" ]; then
            echo "::error:: .ram 内に .ra ストリーム URL が見つかりません"
            exit 1
          fi

          echo "::notice:: RealAudio URL: $STREAM_URL"

          # ファイル名をベースに決定
          BASENAME="${RAM_FILE%.*}"
          OUT_MP3="${BASENAME}.mp3"

          # ストリームをMP3に変換（失敗時エラー）
          ffmpeg -y -i "$STREAM_URL" -vn -c:a libmp3lame -b:a 192k "$OUT_MP3"

      # 4. 生成された MP3 をリポジトリに追加＆プッシュ
      - name: Commit and push MP3
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "*.mp3"
          git commit -m "Add converted MP3 from ${{ github.event.inputs.ram_file }}"
          git push
